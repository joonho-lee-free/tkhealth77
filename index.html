<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>TKHealth 통합 대시보드 (index5)</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { font-size: 24px; margin-bottom: 20px; }
    select, input, button { margin: 5px; padding: 6px; }
    #map { width: 100%; height: 400px; margin: 20px 0; }
    canvas { background: white; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
  </style>
</head>
<body>
  <h1>📊 TKHealth 통합<br>대시보드 (index5)</h1>

  <div>
    <select id="userFilter">
      <option value="tk">TK</option>
      <option value="mom">엄마</option>
      <option value="dad">아빠</option>
    </select>

    <button onclick="requestLocation()">📍 위치 요청</button>

    <input type="date" id="datePicker">
    <button onclick="saveExcel('daily')">일별 Excel 저장</button>

    <input type="month" id="monthPicker">
    <button onclick="saveExcel('monthly')">월별 Excel 저장</button>
  </div>

  <div id="map"></div>

  <h3>1. 기침 데이터</h3>
  <canvas id="coughChart" height="100"></canvas>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDwkLu_Xxr0CMsN8WMYYgfyng2DjQaGTAY",
      authDomain: "tkhealth-30380.firebaseapp.com",
      projectId: "tkhealth-30380",
      storageBucket: "tkhealth-30380.appspot.com",
      messagingSenderId: "538637885397",
      appId: "1:538637885397:web:c2d048de76c402a6e39e9e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let map;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.1796, lng: 129.0756 },
        zoom: 14
      });

      loadMapMarkers();
    }

    function requestLocation() {
      const userId = document.getElementById("userFilter").value;
      db.collection("location_requests").add({
        userId: userId,
        requestAt: new Date().toISOString()
      }).then(() => alert("📡 위치 요청을 보냈습니다."));
    }

    function loadMapMarkers() {
      const userId = document.getElementById("userFilter").value;
      db.collection("tk_location_logs").where("userId", "==", userId)
        .orderBy("timestamp", "desc").limit(50).get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.lat && data.lng) {
              new google.maps.Marker({
                position: { lat: data.lat, lng: data.lng },
                map: map,
                title: new Date(data.timestamp).toLocaleString()
              });
            }
          });
        });
    }

    function fetchData() {
      const userId = document.getElementById("userFilter").value;
      db.collection("tk_cough_logs").where("userId", "==", userId)
        .orderBy("timestamp", "desc").limit(48).get()
        .then(snapshot => {
          const labels = [], data = [];
          snapshot.forEach(doc => {
            const d = doc.data();
            labels.push(new Date(d.timestamp).toLocaleTimeString());
            data.push(d.count);
          });

          const ctx = document.getElementById("coughChart").getContext("2d");
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels.reverse(),
              datasets: [{ label: "기침 횟수", data: data.reverse(), backgroundColor: "#f90" }]
            }
          });
        });
    }

    function saveExcel(type) {
      const value = type === 'monthly'
        ? document.getElementById("monthPicker").value
        : document.getElementById("datePicker").value;
      if (!value) {
        alert(type === 'monthly' ? "월을 선택해주세요" : "날짜를 선택해주세요");
        return;
      }
      window.open(`/tkhealth_excel.html?${type}=${value}`);
    }

    document.getElementById("userFilter").addEventListener("change", () => {
      loadMapMarkers();
      fetchData();
    });

    window.onload = () => {
      initMap();
      fetchData();
    };
  </script>

  <!-- ✅ Google Maps API 개선된 async + defer 적용 -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwkLu_Xxr0CMsN8WMYYgfyng2DjQaGTAY&callback=initMap">
  </script>
</body>
</html>
